#
#  NCATS Translator Modules System
#
# This Dockerfile builds a shared base image with the
# NCATS Translator Modules Code already copied over but
# NO dependencies applied yet (due to slight differences
# and possible conflicts in the various component services
# of the complete (Docker Compose) built system

FROM continuumio/miniconda3:4.7.12

# Setting up Docker Conda environment
# Followed advice at https://medium.com/@chadlagore/conda-environments-with-docker-82cdc9d25754

# **** we won't update conda - now (Oct 2019) seems to be problematic
# RUN conda update -n base -c defaults conda

# Application workspace
RUN mkdir -p /usr/src/app
WORKDIR /usr/src/app

RUN conda create -n translator-modules python=3.7

#  .bashrc will be put into the application workspace?
RUN echo "source conda activate translator-modules" > .bashrc
ENV PATH /opt/conda/envs/translator-modules/bin:/root/.local/bin:$PATH

# Copying over the core Translator Modules application
COPY . ./

# Need to install a local copy of the NCATS translator/modules
# including a temporary override of Ontobio
RUN . /opt/conda/etc/profile.d/conda.sh && \
    conda activate translator-modules && \
    apt-get -y install gcc && \
    pip install --user -e . && \
    pip install -e git+https://github.com/biolink/ontobio.git@master#egg=ontobio --no-cache-dir

# Delegating installment of specific service
# dependencies to the applicable child images

